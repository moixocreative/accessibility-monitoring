name: Sync dist files to DigitalOcean Spaces

on:
  push:
    branches: [ master, development ]

env:
  RCLONE_CONFIG_S3_TYPE: s3
  RCLONE_CONFIG_S3_PROVIDER: DigitalOcean
  RCLONE_CONFIG_S3_ACL: public-read
  RCLONE_CONFIG_S3_ENDPOINT: ${{ secrets.RCLONE_CONFIG_S3_ENDPOINT }}
  RCLONE_CONFIG_S3_SPACE_PRODUCTION: welligence-website
  RCLONE_CONFIG_S3_SPACE_STAGING: welligence-website-staging

jobs:
  sync-dist-files:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup node
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Setup module dependencies cache
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Build
      run: yarn build

    - name: Install rclone
      run: |
        curl -O https://downloads.rclone.org/rclone-current-linux-amd64.deb
        sudo dpkg -i rclone-current-linux-amd64.deb

    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf << EOF
        [s3]
        type = ${{ env.RCLONE_CONFIG_S3_TYPE }}
        provider = ${{ env.RCLONE_CONFIG_S3_PROVIDER }}
        access_key_id = ${{ secrets.RCLONE_CONFIG_S3_ACCESS_KEY_ID }}
        secret_access_key = ${{ secrets.RCLONE_CONFIG_S3_SECRET_ACCESS_KEY }}
        endpoint = ${{ env.RCLONE_CONFIG_S3_ENDPOINT }}
        acl = ${{ env.RCLONE_CONFIG_S3_ACL }}
        EOF

    - name: Set Rclone args based on branch
      run: |
        if [ "$GITHUB_REF" = "refs/heads/master" ]; then
          echo "RCLONE_CONFIG_S3_SPACE=${{ env.RCLONE_CONFIG_S3_SPACE_PRODUCTION }}" >> $GITHUB_ENV
        elif [ "$GITHUB_REF" = "refs/heads/development" ]; then
          echo "RCLONE_CONFIG_S3_SPACE=${{ env.RCLONE_CONFIG_S3_SPACE_STAGING }}" >> $GITHUB_ENV
        fi

    - name: Rclone sync dist/
      run: rclone sync dist/ s3:${{ env.RCLONE_CONFIG_S3_SPACE }}/dist

    - name: Accessibility Post-deploy Check
      run: |
        yarn audit:wcag --post-deploy
        yarn emergency --post-deploy

    - name: Generate Deploy Report
      run: |
        yarn report --deploy --branch ${{ github.ref_name }}
        yarn emergency --report --deploy

    - name: Upload Deploy Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: accessibility-deploy-${{ github.ref_name }}
        path: |
          reports/
          logs/
        retention-days: 30 